<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Manager Pro - Interface Web</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ•Ô∏è THOTH CLOUD</h1>
            <p>Gestion avanc√©e de machines virtuelles KVM/libvirt</p>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">VMs Actives</span>
                    <span class="stat-value" id="running-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">VMs Total</span>
                    <span class="stat-value" id="total-count">0</span>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('vms')">üñ•Ô∏è Machines Virtuelles</button>
            <button class="tab-btn" onclick="switchTab('deploy')">üöÄ D√©ployer une VM</button>
            <button class="tab-btn" onclick="switchTab('monitoring')">üìä Monitoring</button>
            <button class="tab-btn" onclick="switchTab('system')">‚öôÔ∏è Syst√®me</button>
        </div>

        <!-- Tab: VMs List -->
        <div id="tab-vms" class="tab-content active">
            <section class="card">
                <div class="card-header">
                    <h2>üìã Machines Virtuelles</h2>
                    <button onclick="loadVMs()" class="btn btn-primary">üîÑ Actualiser</button>
                </div>
                <div id="vms-list" class="vms-grid">
                    <p class="loading">Chargement...</p>
                </div>
            </section>

            <!-- VM Details -->
            <section id="vm-details" class="card" style="display: none;">
                <div class="card-header">
                    <h2 id="vm-name-title">D√©tails VM</h2>
                    <button onclick="closeDetails()" class="btn btn-secondary">‚úñ Fermer</button>
                </div>
                
                <!-- Actions VM -->
                <div class="vm-actions">
                    <button onclick="startVM()" class="btn btn-success">‚ñ∂Ô∏è D√©marrer</button>
                    <button onclick="shutdownVM()" class="btn btn-warning">‚èπÔ∏è Arr√™ter</button>
                    <button onclick="rebootVM()" class="btn btn-info">üîÑ Red√©marrer</button>
                    <button onclick="pauseVM()" class="btn btn-warning">‚è∏Ô∏è Pause</button>
                    <button onclick="resumeVM()" class="btn btn-success">‚ñ∂Ô∏è Reprendre</button>
                    <button onclick="destroyVM()" class="btn btn-danger">üõë Forcer</button>
                    <button onclick="showCloneModal()" class="btn btn-info">üìã Cloner</button>
                    <button onclick="showConsoleModal()" class="btn btn-primary">üñ•Ô∏è Console</button>
                </div>

                <!-- Stats en temps r√©el -->
                <div id="vm-stats" class="stats-container" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-icon">üñ•Ô∏è</div>
                        <div class="stat-info">
                            <div class="stat-label">CPU Usage</div>
                            <div class="stat-value" id="cpu-usage">0%</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíæ</div>
                        <div class="stat-info">
                            <div class="stat-label">Memory</div>
                            <div class="stat-value" id="memory-usage">0 MB / 0 MB</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíø</div>
                        <div class="stat-info">
                            <div class="stat-label">Disk I/O</div>
                            <div class="stat-value" id="disk-io">R: 0 MB | W: 0 MB</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üåê</div>
                        <div class="stat-info">
                            <div class="stat-label">Network</div>
                            <div class="stat-value" id="network-io">RX: 0 MB | TX: 0 MB</div>
                        </div>
                    </div>
                </div>

                <!-- Infos VM -->
                <div id="vm-info" class="vm-info">
                    <p class="loading">Chargement des informations...</p>
                </div>

                <!-- Snapshots -->
                <div class="snapshots-section">
                    <div class="section-header">
                        <h3>üì∏ Snapshots</h3>
                        <button onclick="showSnapshotModal()" class="btn btn-primary">+ Cr√©er</button>
                    </div>
                    <div id="snapshots-list" class="snapshots-grid">
                        <p class="loading">Chargement des snapshots...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Tab: Deploy VM -->
        <div id="tab-deploy" class="tab-content">
            <section class="card">
                <div class="card-header">
                    <h2>üöÄ D√©ployer une Nouvelle VM</h2>
                </div>
                
                <form id="deploy-form" onsubmit="deployVM(event)" class="deploy-form">
                    <div class="form-section">
                        <h3>üìù Configuration G√©n√©rale</h3>
                        
                        <div class="form-group">
                            <label for="vm-hostname">Hostname de la VM *</label>
                            <input type="text" id="vm-hostname" required placeholder="ex: web-server-01">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="vm-memory">RAM (Mo) *</label>
                                <input type="number" id="vm-memory" required value="2048" min="512" step="512">
                            </div>
                            <div class="form-group">
                                <label for="vm-vcpus">CPU (vCPUs) *</label>
                                <input type="number" id="vm-vcpus" required value="2" min="1" max="8">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="vm-disk">Stockage (Go) *</label>
                            <input type="number" id="vm-disk" required value="20" min="10" max="500">
                        </div>

                        <div class="form-group">
                            <label for="vm-os-variant">Type d'OS *</label>
                            <select id="vm-os-variant" required>
                                <option value="ubuntu22.04">Ubuntu 22.04 LTS</option>
                                <option value="ubuntu20.04">Ubuntu 20.04 LTS</option>
                                <option value="debian11">Debian 11</option>
                                <option value="debian12">Debian 12</option>
                                <option value="centos8">CentOS 8</option>
                                <option value="fedora38">Fedora 38</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="vm-iso-path">Chemin de l'ISO *</label>
                            <input type="text" id="vm-iso-path" required placeholder="/var/lib/libvirt/images/ubuntu-22.04-server.iso">
                            <small>Chemin complet vers l'image ISO sur le serveur</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üë§ Configuration Utilisateur</h3>
                        
                        <div class="form-group">
                            <label for="vm-username">Nom d'utilisateur *</label>
                            <input type="text" id="vm-username" required placeholder="ex: admin">
                        </div>

                        <div class="form-group">
                            <label>M√©thode d'authentification *</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="auth-method" value="password" checked onchange="toggleAuthMethod()">
                                    Mot de passe
                                </label>
                                <label>
                                    <input type="radio" name="auth-method" value="ssh-key" onchange="toggleAuthMethod()">
                                    Cl√© SSH
                                </label>
                            </div>
                        </div>

                        <div id="password-section" class="form-group">
                            <label for="vm-password">Mot de passe *</label>
                            <input type="password" id="vm-password" placeholder="Mot de passe s√©curis√©">
                            <small>‚ö†Ô∏è L'utilisateur devra changer ce mot de passe √† la premi√®re connexion</small>
                        </div>

                        <div id="ssh-key-section" class="form-group" style="display: none;">
                            <label for="vm-ssh-key">Cl√© SSH publique *</label>
                            <textarea id="vm-ssh-key" rows="4" placeholder="ssh-rsa AAAAB3NzaC1yc2EA..."></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üåê Configuration R√©seau</h3>
                        
                        <div class="form-group">
                            <label for="vm-network">Interface r√©seau *</label>
                            <select id="vm-network" required>
                                <option value="default">default (NAT)</option>
                                <option value="bridge=virbr0">Bridge virbr0</option>
                                <option value="bridge=br0">Bridge br0</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="vm-dhcp" checked>
                                Utiliser DHCP (configuration automatique)
                            </label>
                        </div>
                    </div>

                    <div class="info-box">
                        <h4>‚ÑπÔ∏è √Ä propos du d√©ploiement</h4>
                        <ul>
                            <li>‚úÖ La VM sera cr√©√©e avec cloud-init pour la configuration automatique</li>
                            <li>‚úÖ Le backend attend que la VM d√©marre compl√®tement</li>
                            <li>‚úÖ L'adresse IP sera r√©cup√©r√©e et affich√©e automatiquement</li>
                            <li>‚è±Ô∏è Le processus peut prendre quelques minutes</li>
                        </ul>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-success btn-lg">üöÄ D√©ployer la VM</button>
                        <button type="reset" class="btn btn-secondary">üîÑ R√©initialiser</button>
                    </div>
                </form>

                <!-- Deployment Progress -->
                <div id="deployment-progress" class="deployment-progress" style="display: none;">
                    <div class="progress-header">
                        <h3>üöÄ D√©ploiement en cours...</h3>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step" id="step-1">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">G√©n√©ration du cloud-init...</div>
                        </div>
                        <div class="progress-step" id="step-2">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Cr√©ation de la VM...</div>
                        </div>
                        <div class="progress-step" id="step-3">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">D√©marrage de la VM...</div>
                        </div>
                        <div class="progress-step" id="step-4">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Attente de l'initialisation...</div>
                        </div>
                        <div class="progress-step" id="step-5">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">R√©cup√©ration de l'adresse IP...</div>
                        </div>
                    </div>
                    <div id="deployment-result" class="deployment-result" style="display: none;">
                        <div class="result-success">
                            <h3>‚úÖ VM d√©ploy√©e avec succ√®s !</h3>
                            <div class="result-info">
                                <p><strong>Hostname:</strong> <span id="result-hostname"></span></p>
                                <p><strong>Adresse IP:</strong> <span id="result-ip" class="highlight-ip"></span></p>
                                <p><strong>Utilisateur:</strong> <span id="result-username"></span></p>
                                <p><strong>Connexion SSH:</strong></p>
                                <code id="ssh-command"></code>
                                <button onclick="copySshCommand()" class="btn btn-primary btn-sm">üìã Copier la commande</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Tab: Monitoring -->
        <div id="tab-monitoring" class="tab-content">
            <section class="card">
                <div class="card-header">
                    <h2>üìä Monitoring en Temps R√©el</h2>
                    <button onclick="toggleMonitoring()" class="btn btn-primary" id="monitoring-toggle">‚ñ∂Ô∏è D√©marrer</button>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>CPU Usage</h3>
                        <canvas id="cpu-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Memory Usage</h3>
                        <canvas id="memory-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Disk I/O</h3>
                        <canvas id="disk-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Network I/O</h3>
                        <canvas id="network-chart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <!-- Tab: System Info -->
        <div id="tab-system" class="tab-content">
            <section class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Informations Syst√®me</h2>
                    <button onclick="loadSystemInfo()" class="btn btn-primary">üîÑ Actualiser</button>
                </div>
                <div id="system-info" class="vm-info">
                    <p class="loading">Chargement...</p>
                </div>
            </section>
        </div>

        <!-- Modal: Console VNC -->
        <div id="console-modal" class="modal modal-large">
            <div class="modal-content modal-large-content">
                <div class="modal-header">
                    <h3>üñ•Ô∏è Console VM</h3>
                    <button onclick="closeConsoleModal()" class="close-btn">‚úñ</button>
                </div>
                <div class="console-info">
                    <p>‚ö†Ô∏è La console VNC n√©cessite noVNC ou un client VNC configur√©.</p>
                    <p id="vnc-info">Chargement...</p>
                    <div class="vnc-commands">
                        <h4>Connexion via client VNC:</h4>
                        <code id="vnc-command"></code>
                        <button onclick="copyVNCCommand()" class="btn btn-primary btn-sm">üìã Copier</button>
                    </div>
                </div>
                <div id="console-frame" class="console-frame">
                    <p class="console-placeholder">
                        Pour activer la console int√©gr√©e, installez noVNC:<br>
                        <code>sudo apt install novnc</code><br>
                        <code>sudo websockify -D --web=/usr/share/novnc/ 6080 localhost:5900</code>
                    </p>
                </div>
            </div>
        </div>

        <!-- Modal: Cr√©er un snapshot -->
        <div id="snapshot-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üì∏ Cr√©er un Snapshot</h3>
                    <button onclick="closeSnapshotModal()" class="close-btn">‚úñ</button>
                </div>
                <form onsubmit="createSnapshot(event)">
                    <div class="form-group">
                        <label>Nom du snapshot:</label>
                        <input type="text" id="snapshot-name" required placeholder="avant-apache">
                    </div>
                    <div class="form-group">
                        <label>Description (optionnel):</label>
                        <textarea id="snapshot-description" placeholder="VM avant installation Apache"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-success">Cr√©er</button>
                        <button type="button" onclick="closeSnapshotModal()" class="btn btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Cloner VM -->
        <div id="clone-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìã Cloner la VM</h3>
                    <button onclick="closeCloneModal()" class="close-btn">‚úñ</button>
                </div>
                <form onsubmit="cloneVM(event)">
                    <div class="form-group">
                        <label>Nom du clone:</label>
                        <input type="text" id="clone-name" required placeholder="vm-cloud-4107-clone">
                    </div>
                    <div class="info-box">
                        <h4>‚ö†Ô∏è Apr√®s le clonage, modifiez:</h4>
                        <ul>
                            <li>‚úÖ MAC Address (automatique)</li>
                            <li>üîß Hostname</li>
                            <li>üîë SSH host keys</li>
                            <li>üÜî machine-id</li>
                            <li>üåê IP statique (si configur√©e)</li>
                        </ul>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-success">Cloner</button>
                        <button type="button" onclick="closeCloneModal()" class="btn btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <script src="script.js"></script>
</body>
</html>