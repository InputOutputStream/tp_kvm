# Makefile pour le serveur libvirt C++

CXX = g++
CXXFLAGS = -std=c++17 -Wall -O2
INCLUDES = -Iinclude
LIBS = -lvirt -lpthread

SRC = server.cpp
TARGET = build/libvirt_server
BUILD_DIR = build

.PHONY: all clean run setup help install-deps

# Compilation par d√©faut
all: $(TARGET)

# Compilation du serveur
$(TARGET): $(SRC)
	@echo "üî® Compilation du serveur..."
	@mkdir -p $(BUILD_DIR)
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $(TARGET) $(SRC) $(LIBS)
	@echo "‚úÖ Compilation termin√©e : $(TARGET)"

# Setup initial (t√©l√©charge et configure les d√©pendances)
setup:
	@echo "üöÄ Configuration du projet..."
	@chmod +x setup.sh
	@./setup.sh

# Installation des d√©pendances syst√®me
install-deps:
	@echo "üì¶ Installation des d√©pendances syst√®me..."
	sudo apt update
	sudo apt install -y libvirt-dev libvirt-daemon-system g++ make git

# Ex√©cuter le serveur (n√©cessite sudo)
run: $(TARGET)
	@echo "üöÄ D√©marrage du serveur..."
	sudo ./$(TARGET)

# Ex√©cuter en mode debug
debug: CXXFLAGS += -g -DDEBUG
debug: clean $(TARGET)
	@echo "üêõ Mode debug activ√©"
	sudo gdb ./$(TARGET)

# Nettoyage
clean:
	@echo "üßπ Nettoyage..."
	rm -rf $(BUILD_DIR)
	rm -f server.cpp
	@echo "‚úÖ Nettoyage termin√©"

# Nettoyage complet (inclut les d√©pendances)
distclean: clean
	@echo "üßπ Nettoyage complet..."
	rm -rf dependencies include
	@echo "‚úÖ Nettoyage complet termin√©"

# V√©rification de la syntaxe
check:
	@echo "üîç V√©rification de la syntaxe..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only $(SRC)
	@echo "‚úÖ Syntaxe valide"

# Test de compilation rapide
test-compile:
	@echo "‚ö° Test de compilation rapide..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $(SRC) -o /tmp/test.o
	@rm -f /tmp/test.o
	@echo "‚úÖ Test r√©ussi"

# Afficher les informations du syst√®me
info:
	@echo "üìä Informations syst√®me:"
	@echo "  Compilateur: $(CXX) $(shell $(CXX) --version | head -n1)"
	@echo "  Flags: $(CXXFLAGS)"
	@echo "  Libs: $(LIBS)"
	@echo ""
	@echo "üì¶ √âtat des d√©pendances:"
	@if [ -f "include/httplib.h" ]; then echo "  ‚úÖ httplib.h pr√©sent"; else echo "  ‚ùå httplib.h manquant"; fi
	@if [ -f "include/json.hpp" ]; then echo "  ‚úÖ json.hpp pr√©sent"; else echo "  ‚ùå json.hpp manquant"; fi
	@if dpkg -l | grep -q libvirt-dev; then echo "  ‚úÖ libvirt-dev install√©"; else echo "  ‚ùå libvirt-dev manquant"; fi

# Recompilation compl√®te
rebuild: clean all

# Aide
help:
	@echo "üîß Commandes disponibles:"
	@echo ""
	@echo "  make              - Compiler le serveur"
	@echo "  make setup        - Configuration initiale (premi√®re fois)"
	@echo "  make install-deps - Installer les d√©pendances syst√®me"
	@echo "  make run          - Compiler et ex√©cuter le serveur"
	@echo "  make debug        - Compiler en mode debug"
	@echo "  make clean        - Nettoyer les fichiers compil√©s"
	@echo "  make distclean    - Nettoyage complet"
	@echo "  make rebuild      - Recompilation compl√®te"
	@echo "  make check        - V√©rifier la syntaxe"
	@echo "  make info         - Afficher les informations syst√®me"
	@echo "  make help         - Afficher cette aide"
	@echo ""
	@echo "üìù Workflow recommand√©:"
	@echo "  1. make install-deps  (une seule fois)"
	@echo "  2. make setup         (une seule fois)"
	@echo "  3. make run           (pour compiler et lancer)"